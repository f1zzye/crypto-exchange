{% load static %}


        <header class="header">
            <div class="container">
                <div class="header__inner">
                    <div class="header__sname">
                        <a href="https://crypto-chicken.co/" class="header__logo"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/logo.svg" alt=""></a>
                        <div class="header__name"><a href="https://crypto-chicken.co/">CryptoChicken</a></div>
                    </div>

                    <div class="header__right">
                        <div class="header__top">
    <!-- TON Wallet Button вместо Support -->
    <div id="header-wallet-container">
        <button id="header-connect-btn" class="btn header__contacts-support" type="button">
            <span>Connect Wallet</span>
            <svg class="icon icon--fill">
                <use xlink:href="{% static 'img/sprite.svg' %}#wallet"></use>
            </svg>
        </button>

        <button id="header-wallet-info" class="btn header__contacts-support" style="display: none;" type="button">
            <span class="wallet-info">
                <span class="wallet-balance">$0</span>
                <span class="wallet-address">UQDk...zT6b</span>
            </span>
            <svg class="icon icon--fill">
                <use xlink:href="{% static 'img/sprite.svg' %}#wallet"></use>
            </svg>
        </button>
    </div>

    <div class="header__lang js-lang">
        <div class="header__lang-current">
            <span>RU</span>
            <button class="header__lang-open js-lang-open"></button>
        </div>
        <div class="header__lang-drop js-lang-drop">
            <ul>
                <li class="current"><a href="">RU</a></li>
                <li><a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2Fen%2F" rel="nofollow">EN</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Скрытый контейнер для TON Connect -->
<div id="ton-connect-header" style="display: none;"></div>

<style>
.wallet-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
}

.wallet-balance {
    font-weight: 600;
    font-size: 14px;
    color: #333;
}

.wallet-address {
    font-size: 11px;
    color: #666;
    font-weight: normal;
}

.header__contacts-support {
    min-width: 120px;
    text-align: left;
}

.header__contacts-support:hover .wallet-balance {
    color: #fff;
}

.header__contacts-support:hover .wallet-address {
    color: rgba(255, 255, 255, 0.8);
}

/* Dropdown меню для кошелька */
.wallet-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    min-width: 200px;
    z-index: 1000;
    display: none;
}

.wallet-dropdown-item {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.wallet-dropdown-item:hover {
    background-color: #f5f5f5;
}

.wallet-dropdown-item:last-child {
    border-bottom: none;
    color: #dc3545;
}

.wallet-dropdown-item:last-child:hover {
    background-color: #fee;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем TON Connect и делаем глобально доступным
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://7dc4e007bbdd.ngrok-free.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-header'
    });

    // Делаем экземпляр глобально доступным для других страниц
    window.headerTonConnectUI = tonConnectUI;

    const connectBtn = document.getElementById('header-connect-btn');
    const walletInfoBtn = document.getElementById('header-wallet-info');
    const balanceEl = document.querySelector('.wallet-balance');
    const addressEl = document.querySelector('.wallet-address');

    let currentWallet = null;

    // Функция для получения баланса из API
    async function getWalletBalance(address) {
        try {
            const response = await fetch(`/api/wallet-balance/?address=${address}`);
            const data = await response.json();
            return data.balance || '$0';
        } catch (error) {
            console.error('Error fetching balance:', error);
            // Fallback к моку в случае ошибки API
            const mockBalance = (Math.random() * 1000).toFixed(2);
            return `$${mockBalance}`;
        }
    }

    // Функция для форматирования адреса
    function formatAddress(address) {
        if (!address) return 'Unknown';
        return `${address.slice(0, 4)}...${address.slice(-4)}`;
    }

    // Подключение кошелька из header
    connectBtn.onclick = async function() {
        try {
            connectBtn.disabled = true;
            connectBtn.querySelector('span').textContent = 'Connecting...';

            const wallet = await tonConnectUI.connectWallet();
            console.log('Wallet connected from header:', wallet);
        } catch (error) {
            console.error('Connection failed:', error);
        } finally {
            connectBtn.disabled = false;
            connectBtn.querySelector('span').textContent = 'Connect Wallet';
        }
    };

    // Отключение кошелька
    walletInfoBtn.onclick = function(e) {
        e.stopPropagation();
        showWalletDropdown();
    };

    // Dropdown меню для кошелька
    function showWalletDropdown() {
        // Убираем существующий dropdown
        const existingDropdown = document.querySelector('.wallet-dropdown');
        if (existingDropdown) {
            existingDropdown.remove();
        }

        // Создаем новый dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'wallet-dropdown';
        dropdown.style.display = 'block';

        dropdown.innerHTML = `
            <div class="wallet-dropdown-item" onclick="copyAddress()">
                <strong>Copy Address</strong><br>
                <small>${currentWallet ? currentWallet.account.address : ''}</small>
            </div>
            <div class="wallet-dropdown-item" onclick="refreshBalance()">
                <strong>Refresh Balance</strong>
            </div>
            <div class="wallet-dropdown-item" onclick="disconnectWallet()">
                <strong>Disconnect</strong>
            </div>
        `;

        // Позиционируем dropdown
        walletInfoBtn.style.position = 'relative';
        walletInfoBtn.appendChild(dropdown);

        // Закрываем dropdown при клике вне его
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!walletInfoBtn.contains(e.target)) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 100);
    }

    // Функции для dropdown
    window.copyAddress = function() {
        if (currentWallet) {
            navigator.clipboard.writeText(currentWallet.account.address).then(() => {
                console.log('Address copied to clipboard');

                // Добавляем визуальное уведомление
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4caf50;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-weight: 500;
                `;
                notification.textContent = 'Address copied to clipboard!';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy address:', err);
            });
        }
        const dropdown = document.querySelector('.wallet-dropdown');
        if (dropdown) dropdown.remove();
    };

    window.refreshBalance = async function() {
        if (currentWallet) {
            balanceEl.textContent = 'Updating...';
            try {
                const newBalance = await getWalletBalance(currentWallet.account.address);
                balanceEl.textContent = newBalance;

                // Показываем уведомление об обновлении
                console.log('Balance refreshed:', newBalance);
            } catch (error) {
                console.error('Failed to refresh balance:', error);
                balanceEl.textContent = '$0';
            }
        }
        const dropdown = document.querySelector('.wallet-dropdown');
        if (dropdown) dropdown.remove();
    };

    window.disconnectWallet = function() {
        tonConnectUI.disconnect();
        const dropdown = document.querySelector('.wallet-dropdown');
        if (dropdown) dropdown.remove();
    };

    // Слушаем изменения состояния кошелька
    tonConnectUI.onStatusChange(async wallet => {
        if (wallet) {
            currentWallet = wallet;

            // Обновляем UI header
            connectBtn.style.display = 'none';
            walletInfoBtn.style.display = 'block';

            // Устанавливаем адрес
            addressEl.textContent = formatAddress(wallet.account.address);

            // Получаем баланс из API
            balanceEl.textContent = 'Loading...';
            try {
                const balance = await getWalletBalance(wallet.account.address);
                balanceEl.textContent = balance;
                console.log(`Header: Wallet connected: ${wallet.account.address}, Balance: ${balance}`);
            } catch (error) {
                console.error('Failed to load balance:', error);
                balanceEl.textContent = '$0';
            }

        } else {
            currentWallet = null;

            // Возвращаем к кнопке подключения
            connectBtn.style.display = 'block';
            walletInfoBtn.style.display = 'none';

            console.log('Header: Wallet disconnected');
        }
    });

    // Проверяем уже подключенный кошелек
    const existingWallet = tonConnectUI.wallet;
    if (existingWallet) {
        console.log('Header: Found existing wallet connection');
        tonConnectUI.onStatusChange(existingWallet);
    }
});
</script>

                        <div class="header__bottom">
                            <div class="header__nav">
                                <ul id="menu-verhnee-menyu" class="hmenu">
                                    <li id="menu-item-1101" class="menu-item menu-item-type-post_type menu-item-object-page  first_menu_li menu-item-1101"><a href="{% url 'core:aml' %}"><span>AML правила</span></a></li>
                                    <li id="menu-item-1200" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1200"><a href="{% url 'core:raffle' %}"><span>Розыгрыш</span></a></li>
                                    <li id="menu-item-1189" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1189"><a href="{% url 'core:cashback' %}"><span>Kэшбэк</span></a></li>
                                    <li id="menu-item-1279" class="menu-item menu-item-type-post_type menu-item-object-page  last_menu_li menu-item-1279"><a href="{% url 'core:deposit' %}"><span>Депозиты</span></a></li>
                                </ul>
                            </div>
                            {% if user.is_authenticated %}
                                <button class="btn btn--md btn--bd header__btnlog js-open-menu-acc">
                                    <span>{{ user.username }}</span>
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/drop.svg" alt="">
                                </button>
                            {% else %}
                                <div class="header__profile">
                                    <div class="header__lg">
                                        <button class="btn btn--md btn--bd btn--bdg" data-open-login="reg"><span>Регистрация</span></button>
                                    </div>
                                    <button class="btn btn--md btn--pdsm header__btnlog" data-open-login="login">
                                        <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/in.svg" alt="">
                                        <span>Войти</span>
                                    </button>
                                </div>
                                <button class="header__login" data-open-login="login"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/in-color.svg" alt=""></button>
                            {% endif %}

                            <div class="accmenu js-menu-acc">
                                <ul>
                                    <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/profile-menu.svg" alt=""><span>Профиль</span></a></li>
                                    <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/order-menu.svg" alt=""><span>Ваши заявки</span></a></li>
                                    <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/order-menu.svg" alt=""><span>Депозиты</span></a></li>
                                    <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/cashback-menu.svg" alt=""><span>Кешбэк</span></a></li>
                                    <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/check-menu.svg" alt=""><span>AML проверка кошелька</span></a></li>

                                    <li>
                                        <form action="{% url 'accounts:sign-out' %}" method="post" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="accmenu__btnlogout">
                                                <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/out-menu.svg" alt="">
                                                <span>Выход</span>
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>

                            <button class="btn btn--md header__burger js-open-nav">
                                <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/burger.svg" class="hide-tablet-sm" alt="">
                                <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/closed.svg" class="icon-close hide-tablet-sm" alt="">
                                <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/menu_open.svg" class="show-tablet-sm" alt="">
                                <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/menu_closed.svg" class="icon-close show-tablet-sm" alt="">
                            </button>
                        </div>
                    </div>
                </div>
                <div class="accmenu js-menu-acc">
                </div>

                {% include "accounts/sign-in.html" %}

                {% include "accounts/sign-up.html" %}
            </div>


            <div class="navfix js-navfix">
                <div class="container">
                    <div class="navfix__nav">
                        <ul id="menu-verhnee-menyu-1" class="hmenu">
                            <li class="menu-item menu-item-type-post_type menu-item-object-page  first_menu_li menu-item-1101"><a href="{% url 'core:aml' %}"><span>AML правила</span></a></li>
                            <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1200"><a href="{% url 'core:raffle' %}"><span>Розыгрыш</span></a></li>
                            <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1189"><a href="{% url 'core:cashback' %}"><span>Kэшбэк</span></a></li>
                            <li class="menu-item menu-item-type-post_type menu-item-object-page  last_menu_li menu-item-1279"><a href="{% url 'core:deposit' %}"><span>Депозиты</span></a></li>
                        </ul>
                    </div>

                    <div class="navfix__contacts">
                        <a href="/cdn-cgi/l/email-protection#3950575f56795a4b40494d56145a51505a525c57175a56" class="navfix__contacts-val"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/mail.svg" alt=""><span><span class="__cf_email__" data-cfemail="6900070f06290a1b10191d06440a01000a020c07470a06">[email&#160;protected]</span></span></a>
                        <br>
                        <a href="tg://resolve?domain=CryptoChicken_bot" class="navfix__contacts-val"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/tg.svg" alt=""><span>@CryptoChicken_bot</span></a> <br>
                    </div>

                    <div class="navfix__lang">
                        <a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2F" class="navfix__lang-item active"><span>RU</span></a>
                        <a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2Fen%2F" class="navfix__lang-item"><span>EN</span></a></div>
                    <div class="navfix__buttons">
                        <button class="btn btn--bd btn--md btn--chat"><span>Онлайн чат</span></button>
                    </div>
                </div>
            </div>
                {% if messages %}
                    <div class="flash-messages-container">
                        {% for message in messages %}
                            <div class="flash-message flash-{{ message.tags }}">
                                <div class="flash-icon">
                                    {% if message.tags == 'success' %}
                                        <i class="fas fa-check-circle"></i>
                                    {% elif message.tags == 'error' %}
                                        <i class="fas fa-times-circle"></i>
                                    {% elif message.tags == 'warning' %}
                                        <i class="fas fa-exclamation-circle"></i>
                                    {% elif message.tags == 'info' %}
                                        <i class="fas fa-info-circle"></i>
                                    {% else %}
                                        <i class="fas fa-bell"></i>
                                    {% endif %}
                                </div>
                                <span class="flash-text">{{ message }}</span>
                                <button class="flash-close" onclick="closeFlashMessage(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
        </header>
