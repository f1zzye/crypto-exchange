{% load static %}

<header class="header">
    <div class="container">
        <div class="header__inner">
            <div class="header__sname">
                <a href="https://crypto-chicken.co/" class="header__logo"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/logo.svg" alt=""></a>
                <div class="header__name"><a href="https://crypto-chicken.co/">CryptoChicken</a></div>
            </div>

            <div class="header__right">
                <div class="header__top">
                    <div id="header-wallet-container">
                        <button id="header-connect-btn" class="btn btn--md btn--bd" type="button">
                            <i class="fas fa-wallet"></i>
                            <span>Connect Wallet</span>
                        </button>

                        <div id="wallet-button-container" style="position: relative; display: none;">
                            <button id="header-wallet-info" class="btn btn--md btn--bd" type="button">
                                <div class="wallet-btn-content">
                                    <div class="wallet-text-info">
                                        <span class="wallet-balance-display">$0.00</span>
                                        <span class="wallet-address-display">0:bIce...63f5</span>
                                    </div>
                                </div>
                            </button>

                            <div id="wallet-dropdown" class="wallet-dropdown-modal" style="display: none;">
                                <div class="wallet-dropdown-header">
                                    <div class="wallet-dropdown-title">
                                        <img src="{% static 'img/tonconnect-icon.png' %}" alt="Wallet" class="wallet-icon-dropdown-img">
                                        <span id="dropdown-wallet-address">0:bIce...63f5</span>
                                    </div>

                                    <div class="wallet-actions-icons">
                                        <button class="wallet-icon-btn" onclick="copyWalletAddress()" title="Copy Address">
                                            <i class="fas fa-copy"></i>
                                        </button>

                                        <button class="wallet-icon-btn" onclick="refreshWalletBalance()" title="Refresh Balance">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>

                                        <button class="wallet-icon-btn disconnect-btn" onclick="disconnectWalletFromDropdown()" title="Disconnect">
                                            <i class="fas fa-sign-out-alt"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="wallet-dropdown-body">
                                    <div class="wallet-balance-section-dropdown">
                                        <div class="balance-label-dropdown">–ë–∞–ª–∞–Ω—Å TON</div>
                                        <div class="balance-amount-dropdown" id="dropdown-wallet-balance">
                                            < 0.00</div> </div> </div>
                                                <div class="wallet-dropdown-decoration"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="header__lang js-lang">
                                    <div class="header__lang-current">
                                        <span>RU</span>
                                        <button class="header__lang-open js-lang-open"></button>
                                    </div>
                                    <div class="header__lang-drop js-lang-drop">
                                        <ul>
                                            <li class="current"><a href="">RU</a></li>
                                            <li><a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2Fen%2F" rel="nofollow">EN</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div id="ton-connect-header" style="display: none;"></div>

                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    console.log('üöÄ Script loaded!');

                                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TON Connect –∏ –¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º
                                    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                                        manifestUrl: 'https://7dc4e007bbdd.ngrok-free.app/tonconnect-manifest.json',
                                        buttonRootId: 'ton-connect-header'
                                    });

                                    // –î–µ–ª–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
                                    window.headerTonConnectUI = tonConnectUI;

                                    const connectBtn = document.getElementById('header-connect-btn');
                                    const walletContainer = document.getElementById('wallet-button-container');
                                    const walletInfoBtn = document.getElementById('header-wallet-info');
                                    const walletDropdown = document.getElementById('wallet-dropdown');
                                    const balanceEl = document.querySelector('.wallet-balance-display');
                                    const addressEl = document.querySelector('.wallet-address-display');

                                    console.log('üìã Elements found:', {
                                        connectBtn: !!connectBtn,
                                        walletContainer: !!walletContainer,
                                        walletInfoBtn: !!walletInfoBtn,
                                        walletDropdown: !!walletDropdown,
                                        balanceEl: !!balanceEl,
                                        addressEl: !!addressEl
                                    });

                                    let currentWallet = null;
                                    let isDropdownOpen = false;

                                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–∑ API
                                    async function getWalletBalance(address) {
                                        try {
                                            const response = await fetch(`/api/wallet-balance/?address=${address}`);
                                            const data = await response.json();
                                            return data.balance || '$0.00';
                                        } catch (error) {
                                            console.error('Error fetching balance:', error);
                                            return '$0.00';
                                        }
                                    }

                                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –∫–∞–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
                                    function formatAddress(address) {
                                        if (!address) return '0:bIce...63f5';

                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–µ—Ñ–∏–∫—Å "0:"
                                        if (address.startsWith('0:')) {
                                            return `${address.slice(0, 7)}...${address.slice(-4)}`;
                                        } else {
                                            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 0: –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
                                            return `0:${address.slice(0, 4)}...${address.slice(-4)}`;
                                        }
                                    }

                                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                    function showToast(message, type = 'success') {
                                        const toast = document.createElement('div');
                                        toast.className = `toast-notification ${type}`;
                                        toast.textContent = message;
                                        document.body.appendChild(toast);

                                        setTimeout(() => toast.classList.add('show'), 100);

                                        setTimeout(() => {
                                            toast.classList.remove('show');
                                            setTimeout(() => toast.remove(), 300);
                                        }, 3000);
                                    }

                                    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
                                    if (connectBtn) {
                                        connectBtn.onclick = async function() {
                                            try {
                                                connectBtn.disabled = true;
                                                connectBtn.querySelector('span').textContent = 'Connecting...';

                                                const wallet = await tonConnectUI.connectWallet();
                                                console.log('Wallet connected from header:', wallet);
                                            } catch (error) {
                                                console.error('Connection failed:', error);
                                                showToast('Failed to connect wallet', 'error');
                                            } finally {
                                                connectBtn.disabled = false;
                                                connectBtn.querySelector('span').textContent = 'Connect Wallet';
                                            }
                                        };
                                    }

                                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –∫–æ—à–µ–ª—å–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown
                                    if (walletInfoBtn) {
                                        walletInfoBtn.onclick = function(e) {
                                            console.log('üí∞ Wallet button clicked!');
                                            e.preventDefault();
                                            e.stopPropagation();
                                            toggleWalletDropdown();
                                        };
                                    }

                                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è dropdown
                                    function toggleWalletDropdown() {
                                        console.log('üîÑ Toggle dropdown, current state:', isDropdownOpen);
                                        if (isDropdownOpen) {
                                            closeWalletDropdown();
                                        } else {
                                            openWalletDropdown();
                                        }
                                    }

                                    function openWalletDropdown() {
                                        console.log('üìñ Opening dropdown...');

                                        if (!walletDropdown) {
                                            console.error('‚ùå Dropdown element not found!');
                                            return;
                                        }

                                        const dropdownAddress = document.getElementById('dropdown-wallet-address');
                                        const dropdownBalance = document.getElementById('dropdown-wallet-balance');

                                        if (currentWallet) {
                                            dropdownAddress.textContent = formatAddress(currentWallet.account.address);
                                            const balanceValue = balanceEl ? balanceEl.textContent.replace('$', '') : '0.00';
                                            dropdownBalance.textContent = `< ${balanceValue}`;
                                        }

                                        walletDropdown.classList.add('show');
                                        if (walletInfoBtn) walletInfoBtn.classList.add('active');
                                        isDropdownOpen = true;

                                        console.log('‚úÖ Dropdown opened!');

                                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                                        setTimeout(() => {
                                            document.addEventListener('click', handleClickOutside);
                                        }, 100);
                                    }

                                    function closeWalletDropdown() {
                                        console.log('üìï Closing dropdown...');

                                        if (walletDropdown) walletDropdown.classList.remove('show');
                                        if (walletInfoBtn) walletInfoBtn.classList.remove('active');
                                        isDropdownOpen = false;
                                        document.removeEventListener('click', handleClickOutside);
                                    }

                                    function handleClickOutside(e) {
                                        if (walletContainer && !walletContainer.contains(e.target)) {
                                            closeWalletDropdown();
                                        }
                                    }

                                    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –≤ dropdown
                                    window.copyWalletAddress = function() {
                                        if (currentWallet) {
                                            navigator.clipboard.writeText(currentWallet.account.address).then(() => {
                                                showToast('Address copied to clipboard!');
                                            }).catch(err => {
                                                console.error('Failed to copy address:', err);
                                                showToast('Failed to copy address', 'error');
                                            });
                                        }
                                    };

                                    window.refreshWalletBalance = async function() {
                                        if (currentWallet) {
                                            const dropdownBalance = document.getElementById('dropdown-wallet-balance');
                                            if (dropdownBalance) dropdownBalance.textContent = 'Updating...';
                                            if (balanceEl) balanceEl.textContent = 'Loading...';

                                            try {
                                                const newBalance = await getWalletBalance(currentWallet.account.address);
                                                const tonBalance = newBalance.replace('$', '');

                                                if (balanceEl) balanceEl.textContent = newBalance;
                                                if (dropdownBalance) dropdownBalance.textContent = `< ${tonBalance}`;

                                                showToast('Balance updated successfully!');
                                            } catch (error) {
                                                console.error('Failed to refresh balance:', error);
                                                if (balanceEl) balanceEl.textContent = '$0.00';
                                                if (dropdownBalance) dropdownBalance.textContent = '< 0.00';
                                                showToast('Failed to update balance', 'error');
                                            }
                                        }
                                    };

                                    window.disconnectWalletFromDropdown = function() {
                                        tonConnectUI.disconnect();
                                        closeWalletDropdown();
                                        showToast('Wallet disconnected');
                                    };

                                    // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø–æ Escape
                                    document.addEventListener('keydown', function(e) {
                                        if (e.key === 'Escape' && isDropdownOpen) {
                                            closeWalletDropdown();
                                        }
                                    });

                                    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
                                    tonConnectUI.onStatusChange(async wallet => {
                                        console.log('üîÑ Wallet status changed:', !!wallet);

                                        if (wallet) {
                                            currentWallet = wallet;

                                            if (connectBtn) connectBtn.style.display = 'none';
                                            if (walletContainer) walletContainer.style.display = 'block';

                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
                                            if (addressEl) addressEl.textContent = formatAddress(wallet.account.address);

                                            if (balanceEl) balanceEl.textContent = 'Loading...';
                                            try {
                                                const balance = await getWalletBalance(wallet.account.address);
                                                if (balanceEl) balanceEl.textContent = balance;
                                                console.log(`Header: Wallet connected: ${wallet.account.address}, Balance: ${balance}`);
                                            } catch (error) {
                                                console.error('Failed to load balance:', error);
                                                if (balanceEl) balanceEl.textContent = '$0.00';
                                            }

                                        } else {
                                            currentWallet = null;
                                            if (connectBtn) connectBtn.style.display = 'block';
                                            if (walletContainer) walletContainer.style.display = 'none';
                                            closeWalletDropdown();
                                            console.log('Header: Wallet disconnected');
                                        }
                                    });

                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫
                                    const existingWallet = tonConnectUI.wallet;
                                    if (existingWallet) {
                                        console.log('Header: Found existing wallet connection');
                                        tonConnectUI.onStatusChange(existingWallet);
                                    }
                                });
                            </script>

                            <div class="header__bottom">
                                <div class="header__nav">
                                    <ul id="menu-verhnee-menyu" class="hmenu">
                                        <li id="menu-item-1101" class="menu-item menu-item-type-post_type menu-item-object-page  first_menu_li menu-item-1101"><a href="{% url 'core:aml' %}"><span>AML –ø—Ä–∞–≤–∏–ª–∞</span></a></li>
                                        <li id="menu-item-1200" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1200"><a href="{% url 'core:raffle' %}"><span>–†–æ–∑—ã–≥—Ä—ã—à</span></a></li>
                                        <li id="menu-item-1189" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1189"><a href="{% url 'core:cashback' %}"><span>K—ç—à–±—ç–∫</span></a></li>
                                        <li id="menu-item-1279" class="menu-item menu-item-type-post_type menu-item-object-page  last_menu_li menu-item-1279"><a href="{% url 'core:deposit' %}"><span>–î–µ–ø–æ–∑–∏—Ç—ã</span></a></li>
                                    </ul>
                                </div>
                                {% if user.is_authenticated %}
                                <button class="btn btn--md btn--bd header__btnlog js-open-menu-acc">
                                    <span>{{ user.username }}</span>
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/drop.svg" alt="">
                                </button>
                                {% else %}
                                <div class="header__profile">
                                    <div class="header__lg">
                                        <button class="btn btn--md btn--bd btn--bdg" data-open-login="reg"><span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
                                    </div>
                                    <button class="btn btn--md btn--pdsm header__btnlog" data-open-login="login">
                                        <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/in.svg" alt="">
                                        <span>–í–æ–π—Ç–∏</span>
                                    </button>
                                </div>
                                <button class="header__login" data-open-login="login"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/in-color.svg" alt=""></button>
                                {% endif %}

                                <div class="accmenu js-menu-acc">
                                    <ul>
                                        <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/profile-menu.svg" alt=""><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a></li>
                                        <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/order-menu.svg" alt=""><span>–í–∞—à–∏ –∑–∞—è–≤–∫–∏</span></a></li>
                                        <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/order-menu.svg" alt=""><span>–î–µ–ø–æ–∑–∏—Ç—ã</span></a></li>
                                        <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/cashback-menu.svg" alt=""><span>–ö–µ—à–±—ç–∫</span></a></li>
                                        <li><a href=""><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/check-menu.svg" alt=""><span>AML –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—à–µ–ª—å–∫–∞</span></a></li>

                                        <li>
                                            <form action="{% url 'accounts:sign-out' %}" method="post" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="accmenu__btnlogout">
                                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/out-menu.svg" alt="">
                                                    <span>–í—ã—Ö–æ–¥</span>
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>

                                <button class="btn btn--md header__burger js-open-nav">
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/burger.svg" class="hide-tablet-sm" alt="">
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/closed.svg" class="icon-close hide-tablet-sm" alt="">
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/menu_open.svg" class="show-tablet-sm" alt="">
                                    <img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/menu_closed.svg" class="icon-close show-tablet-sm" alt="">
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="accmenu js-menu-acc">
                    </div>

                    {% include "accounts/sign-in.html" %}

                    {% include "accounts/sign-up.html" %}
                </div>

                <div class="navfix js-navfix">
                    <div class="container">
                        <div class="navfix__nav">
                            <ul id="menu-verhnee-menyu-1" class="hmenu">
                                <li class="menu-item menu-item-type-post_type menu-item-object-page  first_menu_li menu-item-1101"><a href="{% url 'core:aml' %}"><span>AML –ø—Ä–∞–≤–∏–ª–∞</span></a></li>
                                <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1200"><a href="{% url 'core:raffle' %}"><span>–†–æ–∑—ã–≥—Ä—ã—à</span></a></li>
                                <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1189"><a href="{% url 'core:cashback' %}"><span>K—ç—à–±—ç–∫</span></a></li>
                                <li class="menu-item menu-item-type-post_type menu-item-object-page  last_menu_li menu-item-1279"><a href="{% url 'core:deposit' %}"><span>–î–µ–ø–æ–∑–∏—Ç—ã</span></a></li>
                            </ul>
                        </div>

                        <div class="navfix__contacts">
                            <a href="/cdn-cgi/l/email-protection#3950575f56795a4b40494d56145a51505a525c57175a56" class="navfix__contacts-val"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/mail.svg" alt=""><span><span class="__cf_email__" data-cfemail="6900070f06290a1b10191d06440a01000a020c07470a06">[email&#160;protected]</span></span></a>
                            <br>
                            <a href="tg://resolve?domain=CryptoChicken_bot" class="navfix__contacts-val"><img src="https://crypto-chicken.co/wp-content/themes/cryptochicken-new-design/images/icons/tg.svg" alt=""><span>@CryptoChicken_bot</span></a> <br>
                        </div>

                        <div class="navfix__lang">
                            <a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2F" class="navfix__lang-item active"><span>RU</span></a>
                            <a href="https://crypto-chicken.co/premium_site_action-set_site_lang.html?meth=get&yid=451a96c1cac6&ynd=0&lang=ru&return_url=https%3A%2F%2Fcrypto-chicken.co%2Fen%2F" class="navfix__lang-item"><span>EN</span></a></div>
                        <div class="navfix__buttons">
                            <button class="btn btn--bd btn--md btn--chat"><span>–û–Ω–ª–∞–π–Ω —á–∞—Ç</span></button>
                        </div>
                    </div>
                </div>
                {% if messages %}
                <div class="flash-messages-container">
                    {% for message in messages %}
                    <div class="flash-message flash-{{ message.tags }}">
                        <div class="flash-icon">
                            {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle"></i>
                            {% elif message.tags == 'error' %}
                            <i class="fas fa-times-circle"></i>
                            {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-circle"></i>
                            {% else %}
                            <i class="fas fa-bell"></i>
                            {% endif %}
                        </div>
                        <span class="flash-text">{{ message }}</span>
                        <button class="flash-close" onclick="closeFlashMessage(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
</header>